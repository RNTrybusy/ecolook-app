<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoLook MVP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        #camera-feed {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #eee; /* Placeholder background */
        }
        #captured-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none; /* Initially hidden */
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 10px; /* Added margin */
        }
        button:hover {
            background-color: #45a049;
        }
         button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #feedback {
            margin-top: 20px;
            font-style: italic;
            color: #555;
            min-height: 1.2em; /* Reserve space to prevent layout shifts */
        }
        #results {
            margin-top: 30px;
            text-align: left;
        }
        #results h3 {
            margin-bottom: 10px;
            color: #333;
        }
        #results ul {
            list-style: none;
            padding: 0;
        }
        #results li {
            background-color: #e9e9e9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        /* Basic Loading Indicator Style */
        .loading::after {
            content: ' .';
            animation: loading-dots 1s infinite;
        }
        @keyframes loading-dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; } /* Optional: make it disappear briefly */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EcoLook MVP</h1>
        <video id="camera-feed" autoplay playsinline></video>
        <img id="captured-image" alt="Foto da roupa capturada">
        <button id="capture-btn">Escanear Roupa</button>
        <button id="scan-another-btn" style="display: none;">Escanear Outra Roupa</button>


        <div id="feedback"></div>

        <div id="results" style="display: none;">
            <h3>Alternativa Sustentável Sugerida:</h3>
            <p id="sustainable-suggestion"></p>
            <h3>Lojas Próximas:</h3>
            <ul id="nearby-stores-list">
                </ul>
        </div>
    </div>

    <script>
        // --- Gerenciamento de Chaves de API (ATENÇÃO: RISCO DE SEGURANÇA NO FRONTEND) ---
        // EM UM AMBIENTE DE PRODUÇÃO REAL, ESTA CHAVE DEVE SER GERENCIADA EM UM BACKEND SEGURO.
        // NUNCA EXPONHA SUAS CHAVES DE API DIRETAMENTE NO CÓDIGO CLIENT-SIDE.
        // Substitua 'SUA_CHAVE_GOOGLE_AQUI' pela chave do seu arquivo .env para testes LOCAIS/MVP.
        const GOOGLE_API_KEY = process.env.GOOGLE_API_KEY; // <-- Substitua aqui para testar
        // Modelo Gemini atualizado conforme solicitado
        const GEMINI_MODEL = 'gemini-2.0-flash';

        const cameraFeed = document.getElementById('camera-feed');
        const capturedImage = document.getElementById('captured-image');
        const captureBtn = document.getElementById('capture-btn');
        const scanAnotherBtn = document.getElementById('scan-another-btn'); // Novo botão
        const feedbackDiv = document.getElementById('feedback');
        const resultsDiv = document.getElementById('results');
        const sustainableSuggestionP = document.getElementById('sustainable-suggestion');
        const nearbyStoresListUl = document.getElementById('nearby-stores-list');
        let currentStream;

        // Função para iniciar a câmera
        async function startCamera() {
            // Verifica se a API de mídia está disponível
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                feedbackDiv.textContent = 'Seu navegador não suporta acesso à câmera.';
                console.error('API navigator.mediaDevices.getUserMedia não disponível.');
                return;
            }

            // Verifica se está em um ambiente seguro (HTTPS ou localhost)
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                 feedbackDiv.innerHTML = 'O acesso à câmera requer um ambiente seguro (HTTPS) ou localhost.<br>Por favor, execute em um servidor web.';
                 console.error('Acesso à câmera bloqueado em ambiente não seguro.');
                 return;
            }


            try {
                feedbackDiv.textContent = 'Solicitando acesso à câmera...';
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraFeed.srcObject = stream;
                currentStream = stream;
                cameraFeed.style.display = 'block';
                capturedImage.style.display = 'none';
                captureBtn.style.display = 'block'; // Mostra o botão de captura
                scanAnotherBtn.style.display = 'none'; // Esconde o botão de escanear outra
                feedbackDiv.textContent = 'Posicione a roupa na frente da câmera.';
                resultsDiv.style.display = 'none';
            } catch (err) {
                console.error("Erro ao acessar a câmera:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    feedbackDiv.textContent = 'Permissão da câmera negada. Por favor, permita o acesso nas configurações do navegador.';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                     feedbackDiv.textContent = 'Nenhuma câmera encontrada no dispositivo.';
                } else if (err.name === 'NotReadableError' || err.name === 'OverconstrainedError') {
                     feedbackDiv.textContent = 'A câmera está em uso ou houve um problema ao acessá-la.';
                }
                else {
                    feedbackDiv.textContent = `Erro ao acessar a câmera: ${err.message}`;
                }
                 captureBtn.style.display = 'none'; // Esconde o botão de captura se a câmera falhar
                 scanAnotherBtn.style.display = 'block'; // Mostra o botão de tentar novamente (escanear outra)
            }
        }

        // Função para parar a câmera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        }

        // Event listener para o botão de captura
        captureBtn.addEventListener('click', async () => {
            if (!currentStream) {
                feedbackDiv.textContent = 'A câmera não está ativa ou não pôde ser iniciada.';
                return;
            }

            // Desabilita o botão de captura e mostra feedback de carregamento
            captureBtn.disabled = true;
            feedbackDiv.textContent = 'Capturando imagem...';
            feedbackDiv.classList.add('loading'); // Adiciona classe para animação de loading

            // Parar a câmera e capturar a imagem
            stopCamera();
            const canvas = document.createElement('canvas');
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/png');

            // Exibir a imagem capturada
            capturedImage.src = imageDataUrl;
            capturedImage.style.display = 'block';
            cameraFeed.style.display = 'none';
            captureBtn.style.display = 'none'; // Esconde o botão de captura
            scanAnotherBtn.style.display = 'none'; // Esconde o botão de escanear outra temporariamente


            feedbackDiv.textContent = 'Analisando sua roupa...';
            resultsDiv.style.display = 'none';
            nearbyStoresListUl.innerHTML = ''; // Limpa resultados anteriores


            // --- Integração com Gemini Vision ---
            const identifiedClothing = await analyzeImageWithGemini(imageDataUrl, GOOGLE_API_KEY, GEMINI_MODEL);
            feedbackDiv.textContent = `Identificado: ${identifiedClothing}. Sugerindo alternativas sustentáveis...`;


            // --- Sugestão Sustentável ---
            const sustainableSuggestion = suggestSustainableAlternative(identifiedClothing);
            sustainableSuggestionP.textContent = sustainableSuggestion;

            feedbackDiv.textContent = 'Buscando lojas próximas...';


            // --- Integração com Google Maps (Obtendo localização real e usando dados mock) ---
            // Sua ideia de usar um Agente Gemini com uma ferramenta Maps é o caminho ideal para uma versão real (requer backend).
            // Para este MVP gratuito e frontend-only, usaremos dados mock para as lojas próximas.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    // Usando a função mock para buscar lojas
                    const nearbyStores = await searchNearbyStoresMock(identifiedClothing, userLocation);
                    feedbackDiv.textContent = 'Resultados encontrados (dados simulados):'; // Indicando que são dados mock
                    resultsDiv.style.display = 'block';
                    displayNearbyStores(nearbyStores);
                     feedbackDiv.classList.remove('loading'); // Remove loading após resultados
                     scanAnotherBtn.style.display = 'block'; // Mostra o botão de escanear outra

                }, (error) => {
                    console.error("Erro ao obter localização:", error);
                    feedbackDiv.textContent = 'Erro ao obter sua localização real para buscar lojas próximas. Exibindo resultados mock.';
                    resultsDiv.style.display = 'block';
                    nearbyStoresListUl.innerHTML = '<li>Não foi possível obter sua localização real. Exibindo dados simulados.</li>';
                     // Fallback para dados mock se a geolocalização falhar
                     searchNearbyStoresMock(identifiedClothing, { lat: -22.2572, lng: -42.5322 }).then(mockStores => {
                         displayNearbyStores(mockStores);
                         feedbackDiv.classList.remove('loading'); // Remove loading após fallback
                         scanAnotherBtn.style.display = 'block'; // Mostra o botão de escanear outra
                     });
                });
            } else {
                feedbackDiv.textContent = 'Geolocalização não suportada neste navegador. Exibindo resultados mock.';
                 resultsDiv.style.display = 'block';
                 nearbyStoresListUl.innerHTML = '<li>Geolocalização não suportada neste navegador. Exibindo dados simulados.</li>';
                 // Fallback para dados mock se a geolocalização não for suportada
                 searchNearbyStoresMock(identifiedClothing, { lat: -22.2572, lng: -42.5322 }).then(mockStores => {
                     displayNearbyStores(mockStores);
                     feedbackDiv.classList.remove('loading'); // Remove loading após fallback
                     scanAnotherBtn.style.display = 'block'; // Mostra o botão de escanear outra
                 });
            }

             captureBtn.disabled = false; // Reabilita o botão de captura (se ele for mostrado novamente)

        });

        // Event listener para o botão "Escanear Outra Roupa"
        scanAnotherBtn.addEventListener('click', () => {
            startCamera(); // Reinicia o fluxo iniciando a câmera
        });


        // --- Funções para Integração com APIs ---

        // Função para analisar imagem com Gemini Vision
        // ATENÇÃO: Para produção, esta chamada deve ser feita por um BACKEND SEGURO.
        async function analyzeImageWithGemini(imageDataUrl, apiKey, model) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    { text: "Descreva a peça de roupa nesta imagem em poucas palavras, focando no tipo e cor principal. Ex: 'camiseta azul', 'calça jeans preta'. Se não for uma peça de roupa, diga 'Não é uma peça de roupa'." },
                                    { inline_data: { mime_type: 'image/png', data: imageDataUrl.split(',')[1] } } // Extrai base64 da URL
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro na API Gemini Vision:", response.status, errorData);
                    return "Não foi possível analisar a roupa."; // Retorna mensagem de erro
                }

                const data = await response.json();
                console.log("Resposta Gemini Vision:", data);

                // Processar a resposta para extrair o tipo de peça
                // A estrutura da resposta pode variar, ajuste conforme necessário
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                     const textResult = data.candidates[0].content.parts[0].text.trim();
                     if (textResult === "Não é uma peça de roupa") {
                         return "Não foi identificado uma peça de roupa na imagem.";
                     }
                     return textResult;
                } else {
                     console.warn("Resposta inesperada da API Gemini Vision:", data);
                     return "Não foi possível identificar a peça.";
                }

            } catch (error) {
                console.error("Erro na chamada fetch para Gemini Vision:", error);
                return "Erro de comunicação com a API de análise.";
            }
        }

        // Função para sugerir alternativa sustentável
        function suggestSustainableAlternative(clothingType) {
            // Lógica simples para sugerir alternativas baseadas no tipo de peça
            // Esta lógica pode ser expandida ou até mesmo usar o Gemini para sugestões mais criativas
             if (clothingType.includes("Não foi identificado") || clothingType.includes("Erro")) {
                 return "Não foi possível sugerir uma alternativa sustentável sem identificar a peça.";
             }
            if (clothingType.includes("camiseta")) {
                return "Considere camisetas de algodão orgânico ou reciclado.";
            } else if (clothingType.includes("calça jeans")) {
                return "Procure por jeans reciclados ou de algodão com menor uso de água.";
            } else if (clothingType.includes("vestido")) {
                return "Alternativas incluem vestidos de linho, cânhamo ou materiais reciclados.";
            } else if (clothingType.includes("jaqueta")) {
                 return "Busque jaquetas de materiais reciclados ou de segunda mão.";
            }
            else {
                return "Busque por opções feitas com materiais sustentáveis ou de segunda mão.";
            }
        }

        // Função MOCK para buscar lojas próximas (Substitui a chamada da API Places para o MVP gratuito)
        // Em uma aplicação real, esta função faria a chamada para uma API de busca de locais (paga, como Google Places,
        // ou via backend com dados de fontes gratuitas como OpenStreetMap - mais complexo),
        // IDEALMENTE orquestrada por um Agente Gemini com a ferramenta Maps em um BACKEND SEGURO.
        async function searchNearbyStoresMock(clothingType, location) {
            console.log(`Simulando busca de lojas próximas para "${clothingType}" na localização:`, location);
            // Simulação de delay para imitar uma chamada de API
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Dados mock de lojas próximas
            const mockStores = [
                { name: "Brechó da Esquina (Mock)", address: "Rua Simulada A, 123", distance: "500m" },
                { name: "Loja Sustentável Verde (Mock)", address: "Av. Simulada B, 456", distance: "1.2km" },
                { name: "Second Hand Fashion (Mock)", address: "Centro Comercial Simulado, Loja 7", distance: "2.5km" },
                 { name: "Eco Moda Brechó (Mock)", address: "Travessa Simulada C, 10", distance: "800m" }
            ];

            // Simula um caso onde nenhum resultado é encontrado ocasionalmente
            // if (Math.random() > 0.7) {
            //     return [];
            // }

            return mockStores; // Retorna lista de lojas mock
        }


        // Função para exibir a lista de lojas
        function displayNearbyStores(stores) {
            if (stores.length === 0) {
                nearbyStoresListUl.innerHTML = '<li>Nenhuma loja sustentável ou brechó encontrado próximo.</li>';
                return;
            }
            nearbyStoresListUl.innerHTML = ''; // Limpa a lista antes de adicionar novos itens
            stores.forEach(store => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${store.name}</strong><br>${store.address}<br>(${store.distance})`;
                nearbyStoresListUl.appendChild(li);
            });
        }

        // Chamar a função para iniciar a câmera quando a janela carregar
        window.addEventListener('load', startCamera);

    </script>
</body>
</html>
